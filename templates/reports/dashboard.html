{% extends 'base.html' %}
{% load static %} {% block title %}Bảng Báo Cáo{% endblock %}

{% block extra_head %}
<style>
    .report-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .report-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
        position: relative;
    }
    .report-card.disabled { opacity: 0.6; }
    .report-card .card-icon {
        width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 15px;
    }
    .report-card .card-icon i { font-size: 1.2rem; }
    .report-card h4 { margin: 0; font-size: 1rem; color: #555; }
    .report-card .card-value { font-size: 2.2rem; font-weight: 700; color: var(--dark-grey); margin: 5px 0; }
    .report-card .card-subtext { font-size: 0.85rem; color: #6c757d; }
    
    .report-detail-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 30px;
    }
    .report-column .dashboard-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background: #fdfdfd;
        box-shadow: none; /* Ghi đè shadow mặc định */
    }
    .report-column h3 { margin-top: 0; }
    .report-column h4 { font-size: 1.1rem; }
    .table-responsive { overflow-y: auto; }
    .table-responsive table { width: 100%; border-collapse: collapse; }
    .table-responsive th {
        background-color: #f1f1f1;
        padding: 8px 10px;
        text-align: left;
        font-size: 0.9rem;
    }
    .table-responsive td { padding: 8px 10px; border-bottom: 1px solid #eee; }
</style>
{% endblock extra_head %} {% block content %}
<div class="container page-container" data-aos="fade-up">

    <h2 data-aos="fade-down">Bảng Báo Cáo Tổng Quan</h2>

    <div class="report-card-grid" data-aos="fade-up" data-aos-delay="100">
        <div class="report-card">
            <div class="card-icon" style="background-color: #d1ecf1;">
                <i class="fas fa-users" style="color: #0c5460;"></i>
            </div>
            <h4>Tổng số User</h4>
            <div class="card-value">{{ total_users }}</div>
            <div class="card-subtext">
                +{{ new_users_today }} hôm nay | +{{ new_users_week }} tuần này | +{{ new_users_month }} tháng này
            </div>
        </div>
        <div class="report-card">
            <div class="card-icon" style="background-color: #d4edda;">
                <i class="fas fa-dollar-sign" style="color: #155724;"></i>
            </div>
            <h4>Tổng Dịch vụ Đã bán</h4>
            <div class="card-value">{{ total_sales }}</div>
            <div class="card-subtext">
                +{{ sales_today }} hôm nay
            </div>
        </div>
        <div class="report-card">
            <div class="card-icon" style="background-color: #fff3cd;">
                <i class="fas fa-headset" style="color: #856404;"></i>
            </div>
            <h4>Yêu cầu Tư vấn</h4>
            <div class="card-value">{{ pending_consults }}</div>
            <div class="card-subtext">
                Đang chờ ({{ completed_consults }} đã hoàn thành)
            </div>
        </div>
        <div class="report-card disabled">
            <div class="card-icon" style="background-color: #e2e3e5;">
                <i class="fas fa-eye" style="color: #5a6268;"></i>
            </div>
            <h4>Lượt truy cập (Demo)</h4>
            <div class="card-value">N/A</div>
            <div class="card-subtext">
                (Cần nâng cấp để xem)
            </div>
        </div>
    </div>
    
    <div class="report-detail-layout">
        <div class="report-column" data-aos="fade-up" data-aos-delay="200">
            <div class="dashboard-section">
                <h3>Báo cáo Bán hàng</h3>
                
                <h4>Theo Dịch vụ (Biểu đồ)</h4>
                <div class="chart-container">
                    <canvas id="salesByServiceChart"></canvas>
                </div>

                <h4 style="margin-top: 20px;">Theo Nhà Cung Cấp (Biểu đồ)</h4>
                <div class="chart-container">
                    <canvas id="salesBySupplierChart"></canvas>
                </div>
            </div>
        </div>
        
        {% if request.user.is_superuser %}
        <div class="report-column" data-aos="fade-up" data-aos-delay="300">
            <div class="dashboard-section">
                <h3>Báo cáo Phân công Tư vấn (Admin)</h3>
                
                <h4>Hiệu suất Tư vấn (Staff)</h4>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="staffConsultChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

</div> {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function getRandomColors(numColors) {
        const colors = [];
        for (let i = 0; i < numColors; i++) {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
        }
        return colors;
    }

    const serviceCtx = document.getElementById('salesByServiceChart');
    if (serviceCtx) {
        const serviceLabels = {{ sales_by_service_labels|safe }};
        const serviceData = {{ sales_by_service_data|safe }};
        new Chart(serviceCtx, {
            type: 'doughnut',
            data: {
                labels: serviceLabels,
                datasets: [{
                    label: 'Lượt bán',
                    data: serviceData,
                    backgroundColor: getRandomColors(serviceData.length),
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
    }

    const supplierCtx = document.getElementById('salesBySupplierChart');
    if (supplierCtx) {
        const supplierLabels = {{ sales_by_supplier_labels|safe }};
        const supplierData = {{ sales_by_supplier_data|safe }};
        new Chart(supplierCtx, {
            type: 'bar',
            data: {
                labels: supplierLabels,
                datasets: [{
                    label: 'Lượt bán theo NCC',
                    data: supplierData,
                    backgroundColor: 'rgba(228, 0, 43, 0.7)',
                    borderColor: 'rgba(228, 0, 43, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    const staffCtx = document.getElementById('staffConsultChart');
    if (staffCtx) {
        const staffLabels = {{ staff_stats_labels|safe }};
        const staffAssigned = {{ staff_stats_assigned|safe }};
        const staffCompleted = {{ staff_stats_completed|safe }};
        new Chart(staffCtx, {
            type: 'bar',
            data: {
                labels: staffLabels,
                datasets: [
                    {
                        label: 'Đã gán (Đang chờ)',
                        data: staffAssigned,
                        backgroundColor: 'rgba(255, 193, 7, 0.7)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Đã hoàn thành',
                        data: staffCompleted,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

});
</script>
{% endblock extra_js %}

{% endblock content %}