{% extends 'base.html' %}
{% load static %}

{% block title %}{{ service.name }}{% endblock %}

{% block extra_head %}
<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --bg:#f8fafc;
    --primary:#e11d48; --primary-600:#be123c; --radius:14px;
    --ok:#16a34a; --info:#0ea5e9; --warn:#f59e0b; --err:#dc2626;
  }
  .wrap{max-width:1200px;margin:24px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:24px}
  @media (max-width: 992px){ .grid{grid-template-columns:1fr} }

  /* Cards / layout */
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
  .gallery{padding:14px}
  .hero{aspect-ratio:16/10;background:#f3f4f6;border-radius:12px;overflow:hidden;border:1px solid #eef2f7}
  .hero img{width:100%;height:100%;object-fit:cover;display:block}
  .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .thumbs button{padding:0;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer;transition:box-shadow .15s,border-color .15s}
  .thumbs img{width:78px;height:78px;object-fit:cover;border-radius:10px;display:block}
  .thumbs button.active,.thumbs button:hover{border-color:var(--primary);box-shadow:0 0 0 1px var(--primary)}

  .tabs{margin-top:16px}
  .tabbar{display:flex;border-bottom:1px solid var(--border)}
  .tabbar button{flex:1;padding:10px 12px;background:#fff;border:none;border-right:1px solid var(--border);cursor:pointer;font-weight:600;color:var(--muted)}
  .tabbar button:last-child{border-right:none}
  .tabbar button.active{color:var(--ink)}
  .tab{display:none;padding:14px}
  .tab.active{display:block}
  .tab h3{margin:0 0 8px;color:var(--ink)}

  .spec table{width:100%}
  .spec td{padding:8px 0;border-bottom:1px dashed #eef2f7}
  .spec td:first-child{width:40%;font-weight:600;color:#334155}

  .album{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .ph{aspect-ratio:4/3;background:#f3f4f6;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
  .ph img{width:100%;height:100%;object-fit:cover;display:block}
  .cap{margin:6px 2px 0;color:var(--muted);font-size:.9rem}

  /* Right: sticky buy box */
  .buy{position:sticky;top: 100px; /* C·∫≠p nh·∫≠t top (100px = chi·ªÅu cao navbar) */ padding:16px}
  .title{font-size:1.6rem;line-height:1.25;margin:0;color:var(--ink)}
  .sub{color:var(--muted);margin:6px 0 10px}
  .price{font-size:1.9rem;font-weight:800;color:var(--primary);margin:8px 0 2px}
  .price--contact{font-size:1.3rem;color:#0b5ed7;font-weight:700}
  .price--free{color:#166534}
  .hr{height:1px;background:#f1f5f9;margin:14px 0}
  .form p{margin:0 0 10px}
  .form label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark-grey); }
  .btn-primary{display:block;width:100%;padding:12px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:700}
  .btn-primary:hover{background:var(--primary-600)}
  .cta2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .btn{display:inline-block;text-align:center;padding:10px;border-radius:10px;font-weight:700;text-decoration:none}
  .btn-outline{border:1px solid var(--primary);color:var(--primary);background:#fff}
  .btn-outline:hover{background:#fff1f3}

  /* Chips */
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.85rem;background:#f1f5f9;color:#334155;border:1px solid #e2e8f0}

  /* --- X√ìA CSS TOAST --- */
</style>
{% endblock %}

{% block content %}
<div class="container page-container" data-aos="fade-up">

  {# ===== TOAST CONTAINER (ƒê√É B·ªä X√ìA) ===== #}

  <div class="grid">
    <section class="card">
      <div class="gallery">
        <figure class="hero">
          <img id="heroImg" alt="{{ service.name }}"
               src="{% if service.thumbnail %}{{ service.thumbnail.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}">
        </figure>

        <div class="thumbs">
          {% if service.thumbnail %}
            <button type="button" class="active" onclick="chgImg('{{ service.thumbnail.url }}', this)" aria-label="·∫¢nh ch√≠nh">
              <img src="{{ service.thumbnail.url }}" alt="thumb">
            </button>
          {% endif %}
          {% for img in service.images.all %}
            <button type="button" onclick="chgImg('{{ img.image.url }}', this)" aria-label="·∫¢nh {{ forloop.counter }}">
              <img src="{{ img.image.url }}" alt="{{ img.caption|default:service.name }}">
            </button>
          {% endfor %}
        </div>
      </div>

      <div class="tabs">
        <div class="tabbar">
          <button type="button" class="active" data-tab="desc" onclick="openTab(this)">M√¥ t·∫£</button>
          <button type="button" data-tab="spec" onclick="openTab(this)">Chi ti·∫øt</button>
          <button type="button" data-tab="album" onclick="openTab(this)">Th∆∞ vi·ªán</button>
        </div>

        <div id="tab-desc" class="tab active">
          <h3>M√¥ t·∫£ d·ªãch v·ª•</h3>
          <div>{{ service.description|linebreaks }}</div>
        </div>

        <div id="tab-spec" class="tab spec">
          <h3>Chi ti·∫øt d·ªãch v·ª•</h3>
          {% if service.details.all %}
            <table class="spec-table">
              <tbody>
              {% for d in service.details.all %}
                <tr>
                  <td>{{ d.title }}</td>
                  <td>{{ d.content|linebreaks }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p style="color: var(--muted)">Ch∆∞a c√≥ th√¥ng s·ªë chi ti·∫øt.</p>
          {% endif %}
        </div>

        <div id="tab-album" class="tab">
          {% if service.images.all %}
            <div class="album">
              {% for img in service.images.all %}
                <div>
                  <div class="ph">
                    <img src="{{ img.image.url }}" alt="{{ img.caption|default:service.name }}">
                  </div>
                  {% if img.caption %}<div class="cap">{{ img.caption }}</div>{% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p style="color: var(--muted)">Ch∆∞a c√≥ h√¨nh ·∫£nh cho d·ªãch v·ª• n√†y.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <aside class="card buy">
      <h2 class="title">{{ service.name }}</h2>
      <div class="sub">M√£ d·ªãch v·ª•: #{{ service.pk }}</div>

      <div>
        {% if service.is_price_on_contact %}
          <div class="price price--contact">Gi√°: Li√™n h·ªá</div>
        {% elif service.price is not None and service.price != 0 %}
          <div class="price">{{ service.price|floatformat:0 }} VNƒê</div>
        {% else %}
          <div class="price price--free">Mi·ªÖn ph√≠</div>
        {% endif %}
      </div>

      <div class="chips">
        {% if service.category %}<span class="chip">Danh m·ª•c: {{ service.category.name }}</span>{% endif %}
        {% if service.supplier %}<span class="chip">Nh√† cung c·∫•p: {{ service.supplier.name }}</span>{% endif %}
      </div>

      <div class="hr"></div>

      {% if user.is_authenticated %}
        <form class="form" action="{% url 'services:add_to_cart' service.pk %}" method="POST">
          {% csrf_token %}
          {{ cart_form.as_p }}
          <button type="submit" class="btn btn-primary" style="font-size: 1rem;">üõí Th√™m v√†o gi·ªè</button>
        </form>

        <div class="cta2">
          <a class="btn btn-outline" href="{% url 'services:purchase_service' service.pk %}">Mua ngay</a>
          <a class="btn btn-outline btn-consult" href="{% url 'request_consultation' service.pk %}" 
             data-service-name="{{ service.name }}">
             Y√™u c·∫ßu T∆∞ v·∫•n
          </a>
        </div>
      {% else %}
        <p>Vui l√≤ng <a href="{% url 'login' %}?next={{ request.path }}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ mua d·ªãch v·ª• ho·∫∑c y√™u c·∫ßu t∆∞ v·∫•n.</p>
      {% endif %}
    </aside>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ƒê·ªïi ·∫£nh ch√≠nh
  function chgImg(src, btn){
    var hero = document.getElementById('heroImg');
    if(hero) hero.src = src;
    document.querySelectorAll('.thumbs button').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
  }
  // Tabs
  function openTab(el){
    var tab = el.getAttribute('data-tab'); // desc | spec | album
    document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-'+tab).classList.add('active');
  }

  // ===== TOAST JAVASCRIPT (ƒê√É B·ªä X√ìA) =====
  
</script>
{% endblock extra_js %}